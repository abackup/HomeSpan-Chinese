<!--  原文时间：2025.2.7，校对时间：2025.2.27 -->

# 无线 (OTA) 更新

HomeSpan 支持无线 (OTA) 更新，它允许你直接从 Arduino IDE *无线*上传草图——无需串口连接。要为你的草图激活此功能，只需在调用 `homeSpan.begin()` 之前调用方法 `homeSpan.enableOTA()`。

在启用 OTA 的情况下运行 HomeSpan 草图时，设备显示为“网络”端口，可以在 Arduino IDE 的 *工具→端口* 菜单下选择该端口。选择后，IDE 将通过 WiFi 将所有上传内容定向到设备，而不是在串口端口上查找。请注意，即使你的设备仍连接到串口端口，你也可以通过 OTA 上传，但 Arduino IDE 目前不支持同时连接多个端口。如果你选择“网络”端口，IDE 将自动关闭串口监视器（如果它是打开的）。要通过“串口”端口恢复上传，只需从 Arduino IDE 的 *工具→端口* 菜单中选择该端口。无论你是否为草图启用了 OTA，始终可以通过串口端口上传。

默认情况下，每当你开始 OTA 上传时，HomeSpan 都需要使用密码。默认 OTA 密码为 "homespan-ota"。在你第一次尝试将草图上传到新连接的设备时，Arduino 会提示你输入此密码。但是，一旦输入特定设备的密码，只要 IDE 运行，Arduino IDE 就会将其保留在内存中，从而使你不必在每次通过 OTA 重新上传草图时再次输入密码。

你可以使用 "O" 命令从 [命令行界面](docs/CLI.md) 更改 HomeSpan 设备的密码。与设备的设置代码类似，HomeSpan 将你指定的 OTA 密码的不可恢复散列版本保存在非易失性存储 (NVS) 中。如果你忘记了你指定的密码，你需要使用 "O" 命令创建一个新密码，或者你可以通过使用 "E" 命令完全擦除 NVS 来恢复默认的 OTA 密码。

还可以通过调用 `homeSpan.enableOTA(const char *pwd)` 从草图中以编程方式更改密码。这不如使用上述方法设置密码安全，因为你的草图将包含纯文本版本，而不是散列版本或密码。请注意，以这种方式设置密码会导致 HomeSpan 忽略但不会更改你使用 "O" 命令保存在 NVS 中的任何密码。

> :exclamation: 虽然不推荐，但你可以在为你的草图启用 OTA 时覆盖密码要求，方法是将 *false* 作为启用方法的参数，如下所示： `homeSpan.enableOTA(false)`。谨慎使用！任何可以通过你的网络访问该设备的人现在都可以上传新草图。

请注意，为了使 OTA 正常运行，你的草图必须使用包含 OTA 分区的分区方案进行编译。分区方案位于 Arduino IDE 的 *工具→Partition Scheme* 菜单下。选择一个表明它支持 OTA 的方案。请注意，标记为“默认”的方案通常包括 OTA 分区。如果不确定，请尝试一下。HomeSpan 会通知你是否这样做。

这是因为如果已为该草图启用 OTA，HomeSpan 会检查该草图是否已使用 OTA 分区编译。如果 OTA 已启用，但 HomeSpan 未找到任何 OTA 分区，它将通过在 WiFi 连接建立后立即发送到串口监视器的警告消息指示它无法启动 OTA 服务器。否则，它会输出一条确认消息，表明 OTA 服务已成功启动。

### OTA 安全加载

HomeSpan 在使用 OTA 上传草图时包括两项额外的安全检查：

1. HomeSpan 检查以确保上传的新草图也是另一个 HomeSpan 草图。如果没有，HomeSpan 将拒绝新的草图，并在新草图上传后但在设备重新启动之前向 Arduino IDE 报告 OTA 错误。相反，HomeSpan 将关闭 OTA 连接并根据现有草图恢复正常操作，而无需重新启动。此安全检查的目的是防止你不小心将非 HomeSpan 草图上传到远程设备上，使你无法在不检索远程设备并通过串口端口连接到你的电脑的情况下重新上传正确的草图。

1. 通过 OTA 成功上传新的 HomeSpan 草图后，HomeSpan 将检查刚刚加载的新 HomeSpan 草图*也*已启用 OTA。此检查在使用新草图重新启动 HomeSpan 后进行。如果 HomeSpan 没有发现 OTA 启用，它会将当前分区标记为无效并重新启动设备，导致设备“回滚”到启用 OTA 的先前版本的草图。此安全检查的目的是确保你不使用 OTA 将新的 HomeSpan 草图上传到远程设备，但未能在新的 HomeSpan 草图中启用 OTA。如果你这样做，你将无法通过 OTA 进行任何进一步更新，而是需要检索远程设备并通过串口端口将其连接到你的电脑。

请注意，这些检查*仅*适用于通过 OTA 上传草图时。只要通过串口端口上传草图，它们就会被忽略。此外，虽然这些安全检查默认启用，但当你首次启用 OTA 时，可以通过将第二个（可选）参数设置为 *false* 来禁用它们： `homeSpan.enableOTA(..., false)`。有关详细信息，请参阅 [API 参考](docs/Reference.md)。

### OTA 回滚

ESP32 操作系统在分区表中用以下 OTA 状态之一标记每个 OTA APP 分区：*NEW*、*PENDING_VERIFY*、*VALID*、*INVALID*、*ABORTED* 或 *UNDEFINED*。每个 OTA App 分区的 OTA 状态决定了引导加载程序是否可以选择该分区在设备重新启动时运行。每当通过 OTA 成功上传新草图时，操作系统都会将草图上传到的分区标记为 *NEW*，将其标记为在启动时运行，然后（通常）重新启动设备。

重新启动后，就在新草图开始运行之前，操作系统会将分区的 OTA 状态从 *NEW* 重新标记为 *PENDING_VERIFY*。当草图从标记为 *PENDING_VERIFY* 的分区运行时，操作系统预计在**下次重新启动设备**之前的某个时间，草图本身会将当前运行的分区重新标记为 *VALID*。如果在分区重新标记为 *VALID* 之前重新启动设备，则重新启动时操作系统会将分区的 OTA 状态重新标记为 *ABORTED*，该分区将不再可启动，相反，引导加载程序将“回滚”以运行存储在最后一个已知 *VALID* 分区中的任何草图。

这样，如果您通过 OTA 将新草图上传到设备中，并且新草图在重新启动后立即崩溃，而不是简单地重复无休止的崩溃和重新启动循环，操作系统可以在第一次崩溃后重新启动时回滚到原始工作草图。一旦原始草图再次运行，您将能够通过 OTA 上传新的（希望是更正的）草图。这是一个非常棒的安全机制，有助于确保您不会意外地通过上传有缺陷的草图（该草图会立即崩溃）导致远程设备无法运行，并阻止其他 OTA 上传。

但是，默认情况下，Arduino-ESP32 库会在初始化阶段自动将任何以 *PENDING_VERIFY* 的 OTA 状态启动的分区重新标记为 *VALID*，**在** Arduino `setup()` 函数被调用之前，因此在您的草图（可能存在导致设备崩溃的错误）有机会运行之前。因此，上述 OTA 回滚机制的安全性完全失效。这是因为如果您的草图崩溃，Arduino-ESP32 库将已经将分区标记为 *VALID*。因此，它将在设备重新启动时再次被选中运行，从而产生我们想要防止的相同的崩溃和重新启动的无限循环。

幸运的是，Arduino-ESP32 库还包含一种方法，可以禁用库自动将 *PENDING_VERIFY* 分区的 OTA 状态重新标记为 *VALID*，从而使草图可以控制是否以及何时将其分区标记为 *VALID*。要在 HomeSpan 中实现此方法，只需将以下内容添加到草图顶部：

```C++
#include "SpanRollback.h"
```

通过将此头文件包含在草图中，Arduino-ESP32 库将不会自动验证通过 OTA 上传的草图，并且分区的 OTA 状态将保持标记为 *PENDING_VERIFY*，直到草图本身决定在下次重新启动（或崩溃）之前将分区重新标记为 *VALID*。要从草图中将分区标记为 *VALID*，请调用 homeSpan 方法 `markSketchOK()`。

请注意，当包含此标头时，用户有责任通过调用 `homeSpan.markSketchOK()` 在草图中的某个位置将分区的 OTA 状态重新标记为 *VALID*。如果没有，则在重新启动（有意或由于恐慌）时，引导加载程序将回滚到先前验证的分区中的先前草图。如果您刚刚上传的草图有一个导致其在早期恐慌和崩溃的错误，则由此产生的回滚是有益的，并将允许您修复问题并重新上传新的草图。但如果您只是忘记将工作草图重新标记为 *VALID*，并且在将来的某个时间点设备重新启动，您会惊讶地发现设备已恢复到草图的先前版本。

使用 SpanRollback 时，您必须回答的一个问题是在草图中的何处和何时执行验证并将分区标记为 *VALID*。如果您过早调用 `homeSpan.markSketchOK()`（即在 `setup()` 函数顶部附近），那么您可能在草图有机会运行所有设置功能之前就对其进行了验证，并且您将无法防止在这些部分中可能发生的任何崩溃或恐慌。

一种可能的选择是等到 WiFi 连接建立后再将分区标记为 *VALID*。这可以在使用 `homeSpan.setConnectionCallback()` 创建的回调中轻松完成。由于此回调在 WiFi 连接建立后才会发生，这必然意味着所有 `setup()` 代码和 HomeSpan 初始化都已运行，并且 HomeSpan `poll()` 任务已被调用多次 --- 如果草图即将崩溃，它可能已经崩溃了。但是，等到这么晚才验证草图的一个缺点是，如果您的设备在重启后无法连接到 WiFi 网络，并且问题出在网络（而不是草图）上，以至于您必须重启设备，那么它将在您重启时回滚到草图的先前版本，因为当前草图尚未验证。

为了避免此问题，另一种可能的选择是尽早验证您的草图，例如在 HomeSpan `poll()` 任务*最初*运行后立即验证。您也可以使用 `homeSpan.setPollingCallback()` 创建回调，从而轻松完成此操作。在此回调中将草图标记为 *VALID* 的优点在于，它发生得足够晚，以确保所有 `setup()` 函数、HomeSpan 初始化以及首次通过 HomeSPan `poll()` 任务都已成功运行且不会崩溃，但不依赖于 WiFi 连接是否已建立。

每个草图都不同，因此选择在何处和何时进行验证，以及是否执行任何特定于草图的验证和测试都取决于您自己的判断和偏好。

### OTA 提示和技巧

* HomeSpan 用于 OTA 的设备名称与你在调用 `homeSpan.begin()` 时分配的名称相同。如果你打算使用 OTA 维护多个设备，请使用 `homeSpan.begin()` 为它们指定不同的名称，以便在从 Arduino IDE 选择要连接的设备时区分它们。

* 使用 `homeSpan.setSketchVersion()` 方法为你的草图设置版本（有关详细信息，请参阅 [API 参考](docs/Reference.md)）。如果指定，HomeSpan 将包含草图版本作为其 HAP MDNS 广播的一部分。这允许你确定哪个版本的草图正在远程 HomeSpan 设备上运行，即使你无法将其插入串口端口以与 Arduino 串口监视器一起使用。除了草图版本，HomeSpan 还在其 MDNS 广播中包含其他有助于识别设备的字段：用于编译草图的 HomeSpan *library* 的版本号，该字段指示是否为草图，编译时使用的 Arduino-ESP32 库的版本号，以及板的类型（例如 *feather_esp32*）。

* 使用 `homeSpan.setCompileTime()` 方法而不指定任何参数，让 HomeSpan 在编译期间使用编译器本身提供的 `__DATE__` 和 `__TIME__` 宏自动设置编译时间（有关详细信息，请参阅 [HomeSpan API](Reference.md)）。此编译时间显示在 Web 日志中，因此在尝试确定通过 OTA 上传的新草图是否确实正在运行，或者该草图是否失败并且系统在重新启动后回滚到以前的版本时很有用。

* 即使您没有在草图顶部添加 `#include "SpanRollback.h"`，也可以主动将当前运行分区的 OTA 状态重新标记为 *INVALID* 并强制立即重新启动和回滚。但是，在草图中将分区标记为 *INVALID* 通常是不必要的，因为如果草图出现严重故障，它可能会在您的草图将其分区标记为 *VALID* 之前崩溃并重新启动，如上所述，这会导致在重新启动期间回滚到之前的工作草图。因此，HomeSpan 没有定义自己的将分区标记为 *INVALID* 的方法，但您可以通过调用底层且名称恰当的 IDF 函数 `esp_ota_mark_app_invalid_rollback_and_reboot()` 来执行此操作。

* 通过 USB 上传的草图通常放置在第一个 OTA APP 分区中，操作系统会自动将其 OTA 状态标记为 *UNDEFINED*。标记为 *UNDEFINED* 的 APP 分区始终可在启动时选择启动。这意味着如果您通过 USB 上传草图并立即崩溃，操作系统 *将* 不会* 回滚到以前的版本，并且将出现无休止的崩溃和重启循环。这是因为，顾名思义，OTA 回滚过程仅在您通过 OTA 上传草图时才适用。但是，如果您的草图在通过 USB 上传后在重启时崩溃，这不会造成问题，因为您仍然可以根据需要多次更正草图并通过 USB 重新上传。与 OTA 上传不同，USB 上传始终是可能的，因为支持 USB 上传的代码内置于引导加载程序本身中。

* 通过 USB 上传时，您的草图可以调用 `homeSpan.markSketchOK()`，尽管没有必要。这会将分区从 *UNDEFINED* 重新标记为 *VALID*，但除此之外没有任何效果，因为如上所述，操作系统始终认为 *UNDEFINED* 分区有效，并将在启动时被选中运行。同样，即使草图已通过 USB 上传，您也可以在草图中调用 `esp_ota_mark_app_invalid_rollback_and_reboot()`。这将重新标记分区 *INVALID*，重新启动设备，并导致回滚到先前的 *VALID*（或 *UNDEFINED*）分区。

* 如果您不确定分区的 OTA 状态，可以使用 CLI `p` 命令将完整分区表打印到串行监视器。每个 OTA App 分区的 OTA 状态都显示在输出中。

* 如上所述，如果分区的 OTA 状态标记为 *NEW*、*VALID* 或 *UNDEFINED*，则引导加载程序 *可选择* 运行它。但这并不意味着该分区保证包含可行的草图。例如，如果您的设备在通过 OTA 将有效草图上传到先前标记为 *VALID* 或 *UNDEFINED* 的分区时断电，则该分区将被损坏，即使其 OTA 状态保持不变。如果引导加载程序随后选择该分区运行，它将立即检测到损坏并尝试另一个分区。如果引导加载程序发现每个可选分区都已损坏或不包含可用的草图，它将无限循环地重新启动，直到您通过 USB 上传新的草图。

* 如果草图只是挂起（例如，无限循环冻结、死锁等），而不是在标记为 *VALID* 之前崩溃，则 OTA 回滚机制本身无法回滚失败的草图，因为它通常无法自行重新启动。您必须关闭设备电源以强制重新启动，此时如果草图尚未标记为 *VALID*，引导加载程序将根据需要回滚到上一个 *VALID* 分区。但是，根据设备的位置，远程关闭电源可能很困难或不可能。要解决此问题，您需要为草图提供即使挂起也能自行重新启动的能力。这可以通过使用 homeSpan `enableWatchdog()` 方法启用 HomeSpan 的看门狗定时器来实现。有关如何使用此附加安全功能的详细信息，请参阅 [HomeSpan 看门狗定时器](WDT.md) 页面。

---

[↩️](../README.md#resources) 返回欢迎页面
